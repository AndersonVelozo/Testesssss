<!DOCTYPE html>
<html lang="pt-BR">
  <head>
    <meta charset="utf-8" />
    <title>HistÃ³rico de Consultas - RADAR</title>
    <meta name="viewport" content="width=device-width, initial-scale=1" />

    <link rel="stylesheet" href="style.css" />

    <style>
      body {
        padding: 24px;
        color: #e5e7eb;
      }

      .hist-card {
        background: rgba(15, 23, 42, 0.6);
        border: 1px solid rgba(148, 163, 184, 0.35);
        padding: 24px;
        border-radius: 16px;
        backdrop-filter: blur(10px);
        max-width: 900px;
        margin: 0 auto;
        box-shadow: 0 10px 35px rgba(0, 0, 0, 0.45);
      }

      h1 {
        margin-top: 0;
        font-size: 1.7rem;
      }

      .datas-lista {
        margin-top: 20px;
        max-height: 360px;
        overflow-y: auto;
        border: 1px solid rgba(148, 163, 184, 0.3);
        padding: 12px;
        border-radius: 12px;
      }

      .linha-data {
        display: flex;
        justify-content: space-between;
        align-items: center;
        padding: 8px 6px;
        border-bottom: 1px solid rgba(148, 163, 184, 0.12);
      }

      .linha-data:last-child {
        border-bottom: none;
      }

      .btn-row {
        display: flex;
        justify-content: center;
        gap: 18px;
        margin-top: 28px;
      }

      .btn-primary {
        background: linear-gradient(135deg, #4f7cff, #3162ff);
        padding: 12px 28px;
        border-radius: 999px;
        border: none;
        color: #fff;
        cursor: pointer;
        font-size: 0.95rem;
        box-shadow: 0 0 16px rgba(79, 124, 255, 0.45);
      }

      .btn-secondary {
        background: transparent;
        border-radius: 999px;
        padding: 12px 28px;
        border: 1px solid rgba(140, 140, 255, 0.4);
        color: #d1d5db;
        cursor: pointer;
        font-size: 0.95rem;
      }

      .status-msg {
        margin-top: 16px;
        font-size: 0.9rem;
        color: #9ca3af;
        text-align: center;
      }

      @media (max-width: 600px) {
        .btn-row {
          flex-direction: column;
        }
        .btn-row button {
          width: 100%;
        }
      }
    </style>
  </head>

  <body>
    <div class="hist-card">
      <h1>ðŸ“† HistÃ³rico de Consultas</h1>
      <p>
        Selecione um ou mais dias de consulta abaixo para gerar um arquivo Excel
        consolidado.
      </p>

      <div id="listaDatas" class="datas-lista">
        <div class="status-msg">Carregando datas...</div>
      </div>

      <div class="btn-row">
        <button id="btnExportar" class="btn-primary">
          ðŸ“Š Exportar selecionados
        </button>
        <button id="btnVoltar" class="btn-secondary">â®œ Voltar</button>
      </div>

      <div id="msg" class="status-msg"></div>
    </div>

    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>

    <script>
      const isLocal =
        location.hostname === "localhost" || location.hostname === "127.0.0.1";

      const BASE = isLocal
        ? "http://localhost:3000"
        : "https://testesssss-production.up.railway.app";

      const listaDatasEl = document.getElementById("listaDatas");
      const btnExportar = document.getElementById("btnExportar");
      const btnVoltar = document.getElementById("btnVoltar");
      const msg = document.getElementById("msg");

      function getToken() {
        return (
          localStorage.getItem("radar_token") ||
          localStorage.getItem("token") ||
          localStorage.getItem("authToken") ||
          ""
        );
      }

      function ensureAuthenticated() {
        const token = getToken();
        if (!token) {
          alert("SessÃ£o expirada. FaÃ§a login novamente.");
          window.location.href = "login.html";
        }
      }

      ensureAuthenticated();

      // ===============================
      // 1. Carregar datas disponÃ­veis
      // ===============================
      async function carregarDatas() {
        listaDatasEl.innerHTML = `<div class="status-msg">Carregando datas...</div>`;

        try {
          const resp = await fetch(`${BASE}/historico/datas`, {
            headers: { Authorization: "Bearer " + getToken() },
          });

          const datas = await resp.json();

          if (!resp.ok) throw datas;

          if (!datas.length) {
            listaDatasEl.innerHTML = `<div class="status-msg">Nenhum histÃ³rico encontrado.</div>`;
            return;
          }

          listaDatasEl.innerHTML = "";

          datas.forEach((d) => {
            const div = document.createElement("div");
            div.className = "linha-data";

            const dataStr = d.dataConsulta || d.data; // compatibilidade

            div.innerHTML = `
    <label>
      <input type="checkbox" class="chk-data" value="${dataStr}" />
      ${dataStr}
    </label>
    <span>${d.total} registros</span>
  `;
            listaDatasEl.appendChild(div);
          });
        } catch (err) {
          console.error(err);
          listaDatasEl.innerHTML = `<div class="status-msg">Erro ao carregar datas.</div>`;
        }
      }

      // ===============================
      // 2. Exportar histÃ³rico selecionado
      // ===============================
      btnExportar.onclick = async () => {
        msg.textContent = "";

        const selecionados = [
          ...document.querySelectorAll(".chk-data:checked"),
        ].map((c) => c.value);

        if (!selecionados.length) {
          msg.textContent = "Selecione pelo menos 1 dia.";
          return;
        }

        msg.textContent = "Buscando registros...";

        let registros = [];

        for (const data of selecionados) {
          try {
            const resp = await fetch(`${BASE}/historico?data=${data}`, {
              headers: { Authorization: "Bearer " + getToken() },
            });
            const json = await resp.json();
            if (resp.ok) registros.push(...json);
          } catch (err) {}
        }

        if (!registros.length) {
          msg.textContent = "Nenhum registro encontrado.";
          return;
        }

        gerarExcelDoHistorico(registros);
        msg.textContent = "Arquivo gerado!";
      };

      // ===============================
      // 3. Gerar Excel
      // ===============================
      function gerarExcelDoHistorico(rows) {
        const ws = XLSX.utils.json_to_sheet(rows);
        const wb = XLSX.utils.book_new();
        XLSX.utils.book_append_sheet(wb, ws, "HistÃ³rico");

        const nome =
          prompt(
            "Nome do arquivo:",
            "historico_" + new Date().toISOString().slice(0, 10)
          ) || "historico";

        XLSX.writeFile(wb, nome + ".xlsx");
      }

      // ===============================
      // 4. Voltar
      // ===============================
      btnVoltar.onclick = () => {
        window.location.href = "index.html";
      };

      // Inicializar
      carregarDatas();
    </script>
  </body>
</html>
